"use strict";function Parser(t,e){this._cbs=t,this._callback=e,this._tagname="",this._attribname="",this._attribvalue="",this._attribs=null,this._stack=[],this._tokenizer=new Tokenizer(this)}function html2nodes(t,e){return new Promise(function(s,a){try{var i="";t=t.replace(/<style.*?>([\s\S]*?)<\/style>/gi,function(){return i+=arguments[1],""});new Parser(new DomHandler(i,e),function(t){return s(t)}).write(t)}catch(t){return a(t)}})}var Tokenizer=require("./Tokenizer.js"),DomHandler=require("./DomHandler.js"),trustAttrs={align:!0,alt:!0,author:!0,autoplay:!0,border:!0,cellpadding:!0,cellspacing:!0,class:!0,color:!0,colspan:!0,controls:!0,"data-src":!0,dir:!0,face:!0,height:!0,href:!0,id:!0,ignore:!0,loop:!0,muted:!0,name:!0,poster:!0,rowspan:!0,size:!0,span:!0,src:!0,start:!0,style:!0,type:!0,"unit-id":!0,width:!0},voidTag={area:!0,base:!0,basefont:!0,br:!0,col:!0,circle:!0,command:!0,ellipse:!0,embed:!0,frame:!0,hr:!0,img:!0,input:!0,isindex:!0,keygen:!0,line:!0,link:!0,meta:!0,param:!0,path:!0,polygon:!0,polyline:!0,rect:!0,source:!0,stop:!0,track:!0,use:!0,wbr:!0};Parser.prototype.ontext=function(t){this._cbs.ontext(t)},Parser.prototype.onopentagname=function(t){t=t.toLowerCase(),this._tagname=t,this._attribs={style:""},voidTag[t]||this._stack.push(t)},Parser.prototype.onopentagend=function(){this._attribs&&(this._cbs.onopentag(this._tagname,this._attribs),this._attribs=null),voidTag[this._tagname]&&this._cbs.onclosetag(this._tagname),this._tagname=""},Parser.prototype.onclosetag=function(t){if(t=t.toLowerCase(),this._stack.length&&!voidTag[t]){var e=this._stack.lastIndexOf(t);if(-1!==e)for(e=this._stack.length-e;e--;)this._cbs.onclosetag(this._stack.pop());else"p"===t&&(this.onopentagname(t),this._closeCurrentTag())}else"br"!==t&&"hr"!==t&&"p"!==t||(this.onopentagname(t),this._closeCurrentTag())},Parser.prototype._closeCurrentTag=function(){var t=this._tagname;this.onopentagend(),this._stack[this._stack.length-1]===t&&(this._cbs.onclosetag(t),this._stack.pop())},Parser.prototype.onattribend=function(){this._attribvalue=this._attribvalue.replace(/&quot;/g,'"'),this._attribs&&trustAttrs[this._attribname]&&(this._attribs[this._attribname]=this._attribvalue),this._attribname="",this._attribvalue=""},Parser.prototype.onend=function(){for(var t=this._stack.length;t>0;this._cbs.onclosetag(this._stack[--t]));this._callback({nodes:this._cbs.nodes,title:this._cbs.title,imgList:this._cbs.imgList})},Parser.prototype.write=function(t){this._tokenizer.parse(t)},module.exports=html2nodes;