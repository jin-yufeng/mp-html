// 小程序富文本插件 https://github.com/jin-yufeng/Parser
function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}(),cfg=require("./config.js"),blankChar=cfg.blankChar,CssHandler=require("./CssHandler.js"),windowWidth=wx.getSystemInfoSync().windowWidth,emoji,MpHtmlParser=function(){function t(i){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,t),this.attrs={},this.CssHandler=new CssHandler(s.tagStyle,windowWidth),this.data=i,this.domain=s.domain,this.DOM=[],this.i=this.start=this.audioNum=this.imgNum=this.videoNum=0,s.prot=(this.domain||"").includes("://")?this.domain.split("://")[0]:"http",this.options=s,this.state=this.Text,this.STACK=[]}return _createClass(t,[{key:"parse",value:function(){emoji&&(this.data=emoji.parseEmoji(this.data));for(var t;t=this.data[this.i];this.i++)this.state(t);for(this.state==this.Text&&this.setText();this.STACK.length;)this.popNode(this.STACK.pop());return this.DOM.length&&(this.DOM[0].PoweredBy="Parser",this.title&&(this.DOM[0].title=this.title)),this.DOM}},{key:"setAttr",value:function(){var t=this.attrName.toLowerCase();if(cfg.trustAttrs[t]){var i=this.attrVal;i?this.attrs[t]="src"==t?this.getUrl(this.decode(i,"amp")):"href"==t||"style"==t?this.decode(i,"amp"):i:cfg.boolAttrs[t]&&(this.attrs[t]="T")}for(this.attrVal="";blankChar[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)}},{key:"setText",value:function(){var t,i=this.section();if(i)if(i=cfg.onText&&cfg.onText(i,function(){return t=!0})||i,t){this.data=this.data.substr(0,this.start)+i+this.data.substr(this.i);var s=this.start+i.length;for(this.i=this.start;this.i<s;this.i++)this.state(this.data[this.i])}else{if(!this.pre){for(var e,a=[],h=i.length;e=i[--h];)(!blankChar[e]||!blankChar[a[0]]&&(e=" "))&&a.unshift(e);i=a.join("")}this.siblings().push({type:"text",text:this.decode(i)})}}},{key:"setNode",value:function(){var t={name:this.tagName.toLowerCase(),attrs:this.attrs},i=cfg.selfClosingTags[t.name];if(this.attrs={},cfg.ignoreTags[t.name])if(i)if("source"==t.name){var s=this.parent();s&&("video"==s.name||"audio"==s.name)&&t.attrs.src&&s.attrs.source.push(t.attrs.src)}else"base"!=t.name||this.domain||(this.domain=t.attrs.href);else this.remove(t);else this.matchAttr(t),i?cfg.filter&&0==cfg.filter(t,this)||this.siblings().push(t):(t.children=[],"pre"==t.name&&cfg.highlight&&(this.remove(t),this.pre=t.pre=!0),this.siblings().push(t),this.STACK.push(t));"/"==this.data[this.i]&&this.i++,this.start=this.i+1,this.state=this.Text}},{key:"remove",value:function(t){var i=this,s=t.name,e=this.i,a=function(){var s=i.data.substring(e,i.i+1);t.attrs.xmlns||(s=' xmlns="http://www.w3.org/2000/svg"'+s);for(var a=e;"<"!=i.data[e];)e--;s=i.data.substring(e,a)+s;var h=i.parent();"100%"==t.attrs.width&&h&&(h.attrs.style||"").includes("inline")&&(h.attrs.style="width:300px;max-width:100%;"+h.attrs.style),i.siblings().push({name:"img",attrs:{src:"data:image/svg+xml;utf8,"+s.replace(/#/g,"%23"),ignore:"T"}})};if("svg"==t.name&&"/"==this.data[e])return a(this.i++);for(;;){if(-1==(this.i=this.data.indexOf("</",this.i+1)))return void(this.i="pre"==s||"svg"==s?e:this.data.length);for(this.start=this.i+=2;!blankChar[this.data[this.i]]&&!this.isClose();)this.i++;if(this.section().toLowerCase()==s)return"pre"==s?(this.data=this.data.substr(0,e+1)+cfg.highlight(this.data.substring(e+1,this.i-5),t.attrs)+this.data.substr(this.i-5),this.i=e):("style"==s?this.CssHandler.getStyle(this.data.substring(e+1,this.i-7)):"title"==s&&(this.title=this.data.substring(e+1,this.i-7)),-1==(this.i=this.data.indexOf(">",this.i))&&(this.i=this.data.length),void("svg"==s&&a()))}}},{key:"matchAttr",value:function(t){var i=t.attrs,s=this.CssHandler.match(t.name,i,t)+(i.style||""),e={};switch(i.id&&(1&this.options.compress?i.id=void 0:this.options.useAnchor&&this.bubble()),2&this.options.compress&&i.class&&(i.class=void 0),t.name){case"a":case"ad":this.bubble();break;case"font":if(i.color&&(e.color=i.color,i.color=void 0),i.face&&(e["font-family"]=i.face,i.face=void 0),i.size){var a=parseInt(i.size);a<1?a=1:a>7&&(a=7);var h=["xx-small","x-small","small","medium","large","x-large","xx-large"];e["font-size"]=h[a-1],i.size=void 0}break;case"video":case"audio":i.id?this[t.name+"Num"]++:i.id=t.name+ ++this[t.name+"Num"],"video"==t.name&&(this.videoNum>3&&(t.lazyLoad=1),i.width&&(e.width=parseFloat(i.width)+(i.width.includes("%")?"%":"px"),i.width=void 0),i.height&&(e.height=parseFloat(i.height)+(i.height.includes("%")?"%":"px"),i.height=void 0)),i.source=[],i.src&&i.source.push(i.src),i.controls||i.autoplay||console.warn("存在没有 controls 属性的 "+t.name+" 标签，可能导致无法播放",t),this.bubble();break;case"td":case"th":if(i.colspan||i.rowspan)for(var r,n=this.STACK.length;r=this.STACK[--n];)if("table"==r.name){r.c=void 0;break}}i.align&&(e["text-align"]=i.align,i.align=void 0);var l=s.split(";");s="";for(var o=0,d=l.length;o<d;o++){var c=l[o].split(":");if(!(c.length<2)){var u=c[0].trim().toLowerCase(),f=c.slice(1).join(":").trim();f.includes("-webkit")||f.includes("-moz")||f.includes("-ms")||f.includes("-o")||f.includes("safe")?s+=";"+u+":"+f:e[u]&&!f.includes("import")&&e[u].includes("import")||(e[u]=f)}}if("img"==t.name){i["data-src"]&&(i.src=i.src||i["data-src"],i["data-src"]=void 0),i.src&&!i.ignore&&(this.bubble()?i.i=(this.imgNum++).toString():i.ignore="T"),i.ignore&&(e["max-width"]="100%");var g;e.width?g=e.width:i.width&&(g=i.width.includes("%")?i.width:i.width+"px"),g&&(e.width=g,i.width="100%",parseInt(g)>windowWidth&&(e.height="",i.height&&(i.height=void 0))),e.height?(i.height=e.height,e.height=""):i.height&&!i.height.includes("%")&&(i.height+="px")}for(var m in e){var p=e[m];if(p){if((m.includes("flex")||"order"==m||"self-align"==m)&&(t.c=1),p.includes("url")){var v=p.indexOf("(");if(-1!=v++){for(;'"'==p[v]||"'"==p[v]||blankChar[p[v]];)v++;p=p.substr(0,v)+this.getUrl(p.substr(v))}}else p.includes("rpx")?p=p.replace(/[0-9.]+\s*rpx/g,function(t){return parseFloat(t)*windowWidth/750+"px"}):"white-space"==m&&p.includes("pre")&&(this.pre=t.pre=!0);s+=";"+m+":"+p}}(s=s.substr(1))&&(i.style=s)}},{key:"popNode",value:function(t){if(t.pre){t.pre=this.pre=void 0;for(var i=this.STACK.length;i--;)this.STACK[i].pre&&(this.pre=!0)}var s=this.siblings(),e=s.length,a=t.children;if("head"==t.name||cfg.filter&&0==cfg.filter(t,this))return s.pop();var h=t.attrs;if(cfg.blockTags[t.name]?t.name="div":cfg.trustTags[t.name]||(t.name="span"),"div"!=t.name&&"p"!=t.name&&"t"!=t.name[0]||(e>1&&" "==s[e-2].text&&s.splice(--e-1,1),a.length&&" "==a[a.length-1].text&&a.pop()),t.c&&("ul"==t.name||"ol"==t.name))if((t.attrs.style||"").includes("list-style:none"))for(var r,n=0;r=a[n++];)"li"==r.name&&(r.name="div");else if("ul"==t.name){for(var l=1,o=this.STACK.length;o--;)"ul"==this.STACK[o].name&&l++;if(1!=l)for(var d=a.length;d--;)a[d].floor=l}else for(var c,u=0,f=1;c=a[u++];)"li"==c.name&&(c.type="ol",c.num=function(t,i){if("a"==i)return String.fromCharCode(97+(t-1)%26);if("A"==i)return String.fromCharCode(65+(t-1)%26);if("i"==i||"I"==i){t=(t-1)%99+1;var s=["I","II","III","IV","V","VI","VII","VIII","IX"],e=["X","XX","XXX","XL","L","LX","LXX","LXXX","XC"],a=(e[Math.floor(t/10)-1]||"")+(s[t%10-1]||"");return"i"==i?a.toLowerCase():a}return t}(f++,h.type)+".");if("table"==t.name){var g=h.cellpadding,m=h.cellspacing,p=h.border;if(t.c&&(this.bubble(),h.style=(h.style||"")+";display:table",g||(g=2),m||(m=2)),p&&(h.style="border:"+p+"px solid gray;"+(h.style||"")),m&&(h.style="border-spacing:"+m+"px;"+(h.style||"")),(p||g||t.c)&&function i(s){for(var e,a=0;e=s[a];a++)if("text"!=e.type){var h=e.attrs.style||"";t.c&&"t"==e.name[0]&&(e.c=1,h+=";display:table-"+("th"==e.name||"td"==e.name?"cell":"tr"==e.name?"row":"row-group")),"th"==e.name||"td"==e.name?(p&&(h="border:"+p+"px solid gray;"+h),g&&(h="padding:"+g+"px;"+h)):i(e.children||[]),h&&(e.attrs.style=h)}}(a),this.options.autoscroll){var v=Object.assign({},t);t.name="div",t.attrs={style:"overflow:scroll"},t.children=[v]}}this.CssHandler.pop&&this.CssHandler.pop(t),"div"!=t.name||Object.keys(h).length||1!=a.length||"div"!=a[0].name||(s[e-1]=a[0])}},{key:"bubble",value:function(){for(var t,i=this.STACK.length;t=this.STACK[--i];){if(cfg.richOnlyTags[t.name])return"table"!=t.name||Object.hasOwnProperty.call(t,"c")||(t.c=1),!1;t.c=1}return!0}},{key:"decode",value:function(t,i){for(var s,e,a=-1;;){if(-1==(a=t.indexOf("&",a+1)))break;if(-1==(s=t.indexOf(";",a+2)))break;"#"==t[a+1]?(e=parseInt(("x"==t[a+2]?"0":"")+t.substring(a+2,s)),isNaN(e)||(t=t.substr(0,a)+String.fromCharCode(e)+t.substr(s+1))):(e=t.substring(a+1,s),(cfg.entities[e]||e==i)&&(t=t.substr(0,a)+(cfg.entities[e]||"&")+t.substr(s+1)))}return t}},{key:"getUrl",value:function(t){return"/"==t[0]?"/"==t[1]?t=this.options.prot+":"+t:this.domain&&(t=this.domain+t):this.domain&&0!=t.indexOf("data:")&&!t.includes("://")&&(t=this.domain+"/"+t),t}},{key:"isClose",value:function(){return">"==this.data[this.i]||"/"==this.data[this.i]&&">"==this.data[this.i+1]}},{key:"section",value:function(){return this.data.substring(this.start,this.i)}},{key:"parent",value:function(){return this.STACK[this.STACK.length-1]}},{key:"siblings",value:function(){return this.STACK.length?this.parent().children:this.DOM}},{key:"Text",value:function(t){if("<"==t){var i=this.data[this.i+1],s=function(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"};s(i)?(this.setText(),this.start=this.i+1,this.state=this.TagName):"/"==i?(this.setText(),s(this.data[++this.i+1])?(this.start=this.i+1,this.state=this.EndTag):this.Comment()):"!"==i&&(this.setText(),this.Comment())}}},{key:"Comment",value:function(){var t;t="--"==this.data.substring(this.i+2,this.i+4)?"--\x3e":"[CDATA["==this.data.substring(this.i+2,this.i+9)?"]]>":">",-1==(this.i=this.data.indexOf(t,this.i+2))?this.i=this.data.length:this.i+=t.length-1,this.start=this.i+1,this.state=this.Text}},{key:"TagName",value:function(t){if(blankChar[t]){for(this.tagName=this.section();blankChar[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)}else this.isClose()&&(this.tagName=this.section(),this.setNode())}},{key:"AttrName",value:function(t){var i=blankChar[t];if(i&&(this.attrName=this.section(),t=this.data[this.i]),"="==t){for(i||(this.attrName=this.section());blankChar[this.data[++this.i]];);this.start=this.i--,this.state=this.AttrValue}else i?this.setAttr():this.isClose()&&(this.attrName=this.section(),this.setAttr())}},{key:"AttrValue",value:function(t){if('"'==t||"'"==t){if(this.start++,-1==(this.i=this.data.indexOf(t,this.i+1)))return this.i=this.data.length;this.attrVal=this.section(),this.i++}else{for(;!blankChar[this.data[this.i]]&&!this.isClose();this.i++);this.attrVal=this.section()}this.setAttr()}},{key:"EndTag",value:function(t){if(blankChar[t]||">"==t||"/"==t){for(var i=this.section().toLowerCase(),s=this.STACK.length;s--&&this.STACK[s].name!=i;);if(-1!=s){for(var e;(e=this.STACK.pop()).name!=i;);this.popNode(e)}else"p"!=i&&"br"!=i||this.siblings().push({name:i,attrs:{}});this.i=this.data.indexOf(">",this.i),this.start=this.i+1,-1==this.i?this.i=this.data.length:this.state=this.Text}}}]),t}();module.exports=MpHtmlParser;