// 小程序富文本插件 https://github.com/jin-yufeng/Parser
var emoji;function t(t){var s=this,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.attrs={},this.CssHandler=new e(h.tagStyle,a),this.data=t,this.domain=h.domain,this.DOM=[],this.i=this.start=this.audioNum=this.imgNum=this.videoNum=0,h.prot=(this.domain||"").includes("://")?this.domain.split("://")[0]:"http",this.options=h,this.state=this.Text,this.STACK=[],this.bubble=function(){for(var t,e=s.STACK.length;t=s.STACK[--e];){if(i.richOnlyTags[t.name])return"table"!=t.name||Object.hasOwnProperty.call(t,"c")||(t.c=1),!1;t.c=1}return!0},this.decode=function(t,s){for(var e,a,h=-1;;){if(-1==(h=t.indexOf("&",h+1)))break;if(-1==(e=t.indexOf(";",h+2)))break;"#"==t[h+1]?(a=parseInt(("x"==t[h+2]?"0":"")+t.substring(h+2,e)),isNaN(a)||(t=t.substr(0,h)+String.fromCharCode(a)+t.substr(e+1))):(a=t.substring(h+1,e),(i.entities[a]||a==s)&&(t=t.substr(0,h)+(i.entities[a]||"&")+t.substr(e+1)))}return t},this.getUrl=function(t){return"/"==t[0]?"/"==t[1]?t=s.options.prot+":"+t:s.domain&&(t=s.domain+t):s.domain&&0!=t.indexOf("data:")&&!t.includes("://")&&(t=s.domain+"/"+t),t},this.isClose=function(){return">"==s.data[s.i]||"/"==s.data[s.i]&&">"==s.data[s.i+1]},this.section=function(){return s.data.substring(s.start,s.i)},this.parent=function(){return s.STACK[s.STACK.length-1]},this.siblings=function(){return s.STACK.length?s.parent().children:s.DOM}}var i=require("./config.js"),s=i.blankChar,e=require("./CssHandler.js"),a=wx.getSystemInfoSync().windowWidth;t.prototype.parse=function(){emoji&&(this.data=emoji.parseEmoji(this.data));for(var t;t=this.data[this.i];this.i++)this.state(t);for(this.state==this.Text&&this.setText();this.STACK.length;)this.popNode(this.STACK.pop());return this.DOM},t.prototype.setAttr=function(){var t=this.attrName.toLowerCase(),e=this.attrVal;for(i.boolAttrs[t]?this.attrs[t]="T":e&&("src"==t||"data-src"==t&&!this.attrs.src?this.attrs.src=this.getUrl(this.decode(e,"amp")):"href"==t||"style"==t?this.attrs[t]=this.decode(e,"amp"):"data-"!=t.substr(0,5)&&(this.attrs[t]=e)),this.attrVal="";s[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)},t.prototype.setText=function(){var t,e=this.section();if(e)if(e=i.onText&&i.onText(e,function(){return t=!0})||e,t){this.data=this.data.substr(0,this.start)+e+this.data.substr(this.i);var a=this.start+e.length;for(this.i=this.start;this.i<a;this.i++)this.state(this.data[this.i])}else{if(!this.pre){for(var h,r=[],n=e.length;h=e[--n];)(!s[h]||!s[r[0]]&&(h=" "))&&r.unshift(h);e=r.join("")}this.siblings().push({type:"text",text:this.decode(e)})}},t.prototype.setNode=function(){var t={name:this.tagName.toLowerCase(),attrs:this.attrs},e=i.selfClosingTags[t.name];if(this.attrs={},i.ignoreTags[t.name])if(e)if("source"==t.name){var h=this.parent();h&&("video"==h.name||"audio"==h.name)&&t.attrs.src&&h.attrs.source.push(t.attrs.src)}else"base"!=t.name||this.domain||(this.domain=t.attrs.href);else this.remove(t);else{var r=t.attrs,n=this.CssHandler.match(t.name,r,t)+(r.style||""),o={};switch(r.id&&(1&this.options.compress?r.id=void 0:this.options.useAnchor&&this.bubble()),2&this.options.compress&&r.class&&(r.class=void 0),t.name){case"a":case"ad":this.bubble();break;case"font":if(r.color&&(o.color=r.color,r.color=void 0),r.face&&(o["font-family"]=r.face,r.face=void 0),r.size){var l=parseInt(r.size);l<1?l=1:l>7&&(l=7);var d=["xx-small","x-small","small","medium","large","x-large","xx-large"];o["font-size"]=d[l-1],r.size=void 0}break;case"embed":var u=t.attrs.src||"",c=t.attrs.type||"";if(c.includes("video")||u.includes(".mp4")||u.includes(".3gp")||u.includes(".m3u8"))t.name="video";else{if(!(c.includes("audio")||u.includes(".m4a")||u.includes(".wav")||u.includes(".mp3")||u.includes(".aac")))break;t.name="audio"}t.attrs.autostart&&(t.attrs.autoplay="T"),t.attrs.controls="T";/*fallsthrough*/case"video":case"audio":r.id?this[t.name+"Num"]++:r.id=t.name+ ++this[t.name+"Num"],"video"==t.name&&(this.videoNum>3&&(t.lazyLoad=1),r.width&&(o.width=parseFloat(r.width)+(r.width.includes("%")?"%":"px"),r.width=void 0),r.height&&(o.height=parseFloat(r.height)+(r.height.includes("%")?"%":"px"),r.height=void 0)),r.source=[],r.src&&(r.source.push(r.src),r.src=void 0),this.bubble();break;case"td":case"th":if(r.colspan||r.rowspan)for(var p,f=this.STACK.length;p=this.STACK[--f];)if("table"==p.name){p.c=void 0;break}}r.align&&(o["text-align"]=r.align,r.align=void 0);var m=n.split(";");n="";for(var g=0,v=m.length;g<v;g++){var b=m[g].split(":");if(!(b.length<2)){var x=b[0].trim().toLowerCase(),y=b.slice(1).join(":").trim();y.includes("-webkit")||y.includes("-moz")||y.includes("-ms")||y.includes("-o")||y.includes("safe")?n+=";"+x+":"+y:o[x]&&!y.includes("import")&&o[x].includes("import")||(o[x]=y)}}if("img"==t.name){r.src&&!r.ignore&&(this.bubble()?r.i=(this.imgNum++).toString():r.ignore="T"),r.ignore&&(n+=";-webkit-touch-callout:none",o["max-width"]="100%"),o.position||(o.top=o.bottom=o.left=o.right=o["z-index"]=void 0);var C;o.width?C=o.width:r.width&&(C=r.width.includes("%")?r.width:r.width+"px"),C&&(o.width=C,r.width="100%",parseInt(C)>a&&(o.height="",r.height&&(r.height=void 0))),o.height?(r.height=o.height,o.height=""):r.height&&!r.height.includes("%")&&(r.height+="px")}for(var T in o){var w=o[T];if(w){if((T.includes("flex")||"order"==T||"self-align"==T)&&(t.c=1),w.includes("url")){var A=w.indexOf("(");if(-1!=A++){for(;'"'==w[A]||"'"==w[A]||s[w[A]];)A++;w=w.substr(0,A)+this.getUrl(w.substr(A))}}else w.includes("rpx")?w=w.replace(/[0-9.]+\s*rpx/g,function(t){return parseFloat(t)*a/750+"px"}):"white-space"==T&&w.includes("pre")&&!e&&(this.pre=t.pre=!0);n+=";"+T+":"+w}}n=n.substr(1),n&&(r.style=n),e?i.filter&&0==i.filter(t,this)||this.siblings().push(t):(t.children=[],"pre"==t.name&&i.highlight&&(this.remove(t),this.pre=t.pre=!0),this.siblings().push(t),this.STACK.push(t))}"/"==this.data[this.i]&&this.i++,this.start=this.i+1,this.state=this.Text},t.prototype.remove=function(t){var e=this,a=t.name,h=this.i,r=function(){var i=e.data.substring(h,e.i+1);t.attrs.xmlns||(i=' xmlns="http://www.w3.org/2000/svg"'+i);for(var s=h;"<"!=e.data[h];)h--;i=e.data.substring(h,s)+i;var a=e.parent();"100%"==t.attrs.width&&a&&(a.attrs.style||"").includes("inline")&&(a.attrs.style="width:300px;max-width:100%;"+a.attrs.style),e.siblings().push({name:"img",attrs:{src:"data:image/svg+xml;utf8,"+i.replace(/#/g,"%23"),style:(/vertical[^;]+/.exec(t.attrs.style)||[]).shift(),ignore:"T"}})};if("svg"==t.name&&"/"==this.data[h])return r(this.i++);for(;;){if(-1==(this.i=this.data.indexOf("</",this.i+1)))return void(this.i="pre"==a||"svg"==a?h:this.data.length);for(this.start=this.i+=2;!s[this.data[this.i]]&&!this.isClose();)this.i++;if(this.section().toLowerCase()==a)return"pre"==a?(this.data=this.data.substr(0,h+1)+i.highlight(this.data.substring(h+1,this.i-5),t.attrs)+this.data.substr(this.i-5),this.i=h):("style"==a?this.CssHandler.getStyle(this.data.substring(h+1,this.i-7)):"title"==a&&(this.DOM.title=this.data.substring(h+1,this.i-7)),-1==(this.i=this.data.indexOf(">",this.i))&&(this.i=this.data.length),void("svg"==a&&r()))}},t.prototype.popNode=function(t){if(t.pre){t.pre=this.pre=void 0;for(var s=this.STACK.length;s--;)this.STACK[s].pre&&(this.pre=!0)}var e=this.siblings(),a=e.length,h=t.children;if("head"==t.name||i.filter&&0==i.filter(t,this))return e.pop();var r=t.attrs;if(i.blockTags[t.name]?t.name="div":i.trustTags[t.name]||(t.name="span"),"div"!=t.name&&"p"!=t.name&&"t"!=t.name[0]||(a>1&&" "==e[a-2].text&&e.splice(--a-1,1),h.length&&" "==h[h.length-1].text&&h.pop()),t.c&&("ul"==t.name||"ol"==t.name))if((t.attrs.style||"").includes("list-style:none"))for(var n,o=0;n=h[o++];)"li"==n.name&&(n.name="div");else if("ul"==t.name){for(var l=1,d=this.STACK.length;d--;)"ul"==this.STACK[d].name&&l++;if(1!=l)for(var u=h.length;u--;)h[u].floor=l}else for(var c,p=0,f=1;c=h[p++];)"li"==c.name&&(c.type="ol",c.num=function(t,i){if("a"==i)return String.fromCharCode(97+(t-1)%26);if("A"==i)return String.fromCharCode(65+(t-1)%26);if("i"==i||"I"==i){t=(t-1)%99+1;var s=["I","II","III","IV","V","VI","VII","VIII","IX"],e=["X","XX","XXX","XL","L","LX","LXX","LXXX","XC"],a=(e[Math.floor(t/10)-1]||"")+(s[t%10-1]||"");return"i"==i?a.toLowerCase():a}return t}(f++,r.type)+".");if("table"==t.name){var m=r.cellpadding,g=r.cellspacing,v=r.border;if(t.c&&(this.bubble(),r.style=(r.style||"")+";display:table",m||(m=2),g||(g=2)),v&&(r.style="border:"+v+"px solid gray;"+(r.style||"")),g&&(r.style="border-spacing:"+g+"px;"+(r.style||"")),(v||m||t.c)&&function i(s){for(var e,a=0;e=s[a];a++)if("text"!=e.type){var h=e.attrs.style||"";t.c&&"t"==e.name[0]&&(e.c=1,h+=";display:table-"+("th"==e.name||"td"==e.name?"cell":"tr"==e.name?"row":"row-group")),"th"==e.name||"td"==e.name?(v&&(h="border:"+v+"px solid gray;"+h),m&&(h="padding:"+m+"px;"+h)):i(e.children||[]),h&&(e.attrs.style=h)}}(h),this.options.autoscroll){var b=Object.assign({},t);t.name="div",t.attrs={style:"overflow:scroll"},t.children=[b]}}this.CssHandler.pop&&this.CssHandler.pop(t),"div"!=t.name||Object.keys(r).length||1!=h.length||"div"!=h[0].name||(e[a-1]=h[0])},t.prototype.Text=function(t){if("<"==t){var i=this.data[this.i+1],s=function(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"};s(i)?(this.setText(),this.start=this.i+1,this.state=this.TagName):"/"==i?(this.setText(),s(this.data[++this.i+1])?(this.start=this.i+1,this.state=this.EndTag):this.Comment()):"!"!=i&&"?"!=i||(this.setText(),this.Comment())}},t.prototype.Comment=function(){var t;t="--"==this.data.substring(this.i+2,this.i+4)?"--\x3e":"[CDATA["==this.data.substring(this.i+2,this.i+9)?"]]>":">",-1==(this.i=this.data.indexOf(t,this.i+2))?this.i=this.data.length:this.i+=t.length-1,this.start=this.i+1,this.state=this.Text},t.prototype.TagName=function(t){if(s[t]){for(this.tagName=this.section();s[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)}else this.isClose()&&(this.tagName=this.section(),this.setNode())},t.prototype.AttrName=function(t){if("="==t||s[t]||this.isClose()){if(this.attrName=this.section(),s[t])for(;s[this.data[++this.i]];);if("="==this.data[this.i]){for(;s[this.data[++this.i]];);this.start=this.i--,this.state=this.AttrValue}else this.setAttr()}},t.prototype.AttrValue=function(t){if('"'==t||"'"==t){if(this.start++,-1==(this.i=this.data.indexOf(t,this.i+1)))return this.i=this.data.length;this.attrVal=this.section(),this.i++}else{for(;!s[this.data[this.i]]&&!this.isClose();this.i++);this.attrVal=this.section()}this.setAttr()},t.prototype.EndTag=function(t){if(s[t]||">"==t||"/"==t){for(var i=this.section().toLowerCase(),e=this.STACK.length;e--&&this.STACK[e].name!=i;);if(-1!=e){for(var a;(a=this.STACK.pop()).name!=i;)this.popNode(a);this.popNode(a)}else"p"!=i&&"br"!=i||this.siblings().push({name:i,attrs:{}});this.i=this.data.indexOf(">",this.i),this.start=this.i+1,-1==this.i?this.i=this.data.length:this.state=this.Text}},module.exports=t